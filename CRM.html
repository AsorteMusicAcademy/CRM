<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Session Tracker</title>
    
    <!-- ADDED: Google Identity Services (GIS) Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- Container for the entire widget. -->
    <div id="client-tracker-widget" class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-800">Client Session Tracker</h1>
            <p class="text-lg text-gray-500 mt-2">Manage client sessions from Google Calendar & Classroom</p>
        </header>

        <!-- MODIFIED: Login View (shown first) -->
        <div id="login-view" class="max-w-2xl mx-auto text-center">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Please Sign In</h2>
                <p class="text-gray-600 mb-6">This application requires access to your Google account to manage Calendar and Classroom data.</p>
                <!-- Google Sign-In button will be rendered here by the script -->
                <div id="google-signin-button" class="flex justify-center"></div>
            </div>
        </div>

        <!-- MODIFIED: Main App View (initially hidden) -->
        <div id="main-app-view" style="display: none;">
            <!-- Configuration Section (Access token field removed) -->
            <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-md space-y-4 mb-8">
                <div>
                    <label for="calendarId" class="block text-sm font-medium text-gray-700 mb-1">Google Calendar ID</label>
                    <input type="email" id="calendarId" value="asorteoffice@gmail.com" placeholder="e.g., primary or user@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="relative">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><i data-lucide="search" class="h-5 w-5 text-gray-400"></i></div>
                    <input type="text" id="searchQuery" placeholder="Caută client global..." class="block w-full rounded-md border-gray-300 pl-10 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3">
                </div>

                <div id="tab-controls">
                    <div class="flex justify-center border-b border-gray-200">
                        <button data-tab="today" class="tab-button flex-1 text-center px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-blue-600 text-blue-600 bg-blue-50">Astăzi</button>
                        <button data-tab="tomorrow" class="tab-button flex-1 text-center px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 text-gray-500 hover:text-gray-700 hover:bg-gray-100">Mâine</button>
                        <button data-tab="all" class="tab-button flex-1 text-center px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 text-gray-500 hover:text-gray-700 hover:bg-gray-100">Toți Clienții</button>
                    </div>
                    <button id="fetchEventsBtn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-gray-400 transition-all duration-300 ease-in-out">
                        Afișează programările pentru astăzi
                    </button>
                </div>
            </div>

            <!-- Notification Area -->
            <div id="notification-area" class="max-w-4xl mx-auto mb-6"></div>

            <!-- Results Area -->
            <div id="results-area" class="max-w-4xl mx-auto">
                <!-- Loading spinner will be injected here -->
                <!-- Client list will be injected here -->
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- NEW: Google Sign-In Configuration ---
            // =======================================================================
            // ==> PASTE YOUR GOOGLE CLIENT ID HERE <==
            // =======================================================================
            const GOOGLE_CLIENT_ID = '1042460892509-gmoih87sc14vmkc4td34bal6h8cbjgof.apps.googleusercontent.com';
            const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/classroom.coursework.students https://www.googleapis.com/auth/classroom.courses.readonly';
            let tokenClient;

            // --- STATE MANAGEMENT ---
            let state = {
                accessToken: null, // Will be set after login
                calendarId: 'asorteoffice@gmail.com',
                clients: {},
                courses: null,
                activeTab: 'today',
                searchQuery: '',
                isLoading: false,
                isSearching: false,
                fetched: false,
                expandedClient: null,
            };

            // --- DOM ELEMENT REFERENCES (MODIFIED) ---
            const dom = {
                loginView: document.getElementById('login-view'),
                mainAppView: document.getElementById('main-app-view'),
                googleSigninButton: document.getElementById('google-signin-button'),
                calendarIdInput: document.getElementById('calendarId'),
                searchQueryInput: document.getElementById('searchQuery'),
                fetchEventsBtn: document.getElementById('fetchEventsBtn'),
                notificationArea: document.getElementById('notification-area'),
                resultsArea: document.getElementById('results-area'),
                tabControls: document.getElementById('tab-controls'),
                tabButtons: document.querySelectorAll('.tab-button'),
            };

            // --- NEW: Authorization Logic ---
            function initializeGsi() {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            state.accessToken = tokenResponse.access_token;
                            
                            // Hide login view, show the main app
                            dom.loginView.style.display = 'none';
                            dom.mainAppView.style.display = 'block';

                            // Now that we have the token, initialize the main app logic
                            initializeApp();
                        }
                    },
                });

                // Render the Google Sign-In button
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: () => {
                        // When the user is identified, request the access token with the necessary scopes
                        requestAccessToken();
                    }
                });

                google.accounts.id.renderButton(
                    dom.googleSigninButton,
                    { theme: 'outline', size: 'large', text: 'signin_with', shape: 'rectangular' }
                );
            }

            function requestAccessToken() {
                // This prompts the user for consent and gets the token.
                tokenClient.requestAccessToken();
            }

            // --- NEW: Main App Initialization ---
            function initializeApp() {
                // Fetch Classroom courses as soon as we have the token
                if (state.accessToken && !state.courses) {
                    api.fetchCourses()
                        .then(courses => { state.courses = courses; })
                        .catch(err => renderNotification(`Failed to fetch courses: ${err.message}`, 'error'));
                }

                // Attach all application event listeners
                attachAppEventListeners();

                // Set up the initial UI state for the main app
                updateUI();
                handleFetchEvents(); // Automatically fetch today's events on load
                lucide.createIcons(); // Render icons inside the newly visible main app view
            }
            
            const getWhatsAppLink = (phone, text = '') => {
                if (!phone) return null;
                let cleanPhoneNumber = phone.replace(/\s/g, '');
                if (cleanPhoneNumber.startsWith('0')) cleanPhoneNumber = '40' + cleanPhoneNumber.substring(1);
                else if (!cleanPhoneNumber.startsWith('40')) cleanPhoneNumber = '40' + cleanPhoneNumber;
                let link = `https://wa.me/${cleanPhoneNumber}`;
                if (text) link += `?text=${encodeURIComponent(text)}`;
                return link;
            };

            const isPaymentOverdue = (paymentDateStr) => {
                if (!paymentDateStr) return false;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const paymentDate = new Date(paymentDateStr.split(' - ')[0]);
                const timeDifference = today.getTime() - paymentDate.getTime();
                const daysDifference = timeDifference / (1000 * 3600 * 24);
                return daysDifference > 30;
            };

            const processCalendarItems = (items) => {
                const processedClients = {};
                if (!items) return processedClients;
                items.filter(event => event.status !== 'cancelled' && !(event.organizer && event.attendees && event.attendees.find(a => a.email === event.organizer.email)?.responseStatus === 'declined'))
                    .forEach(event => {
                        if (!event.summary) return;
                        const parts = event.summary.split(' - ');
                        if (parts.length !== 3) return;
                        const [name, discipline, sessionPart] = parts.map(p => p.trim());
                        const sessionNumber = parseInt(sessionPart.toLowerCase().replace('sedinta', '').replace('#', ''), 10);
                        if (isNaN(sessionNumber)) return;

                        let phone = null, lastPayment = null;
                        if (event.description) {
                            const phoneMatch = event.description.match(/(\d{10}|\d{4}\s\d{3}\s\d{3})/);
                            if (phoneMatch) phone = phoneMatch[0];
                            const paymentMatch = event.description.match(/Last Payment: (.*)/);
                            if (paymentMatch) lastPayment = paymentMatch[1];
                        }
                        const studentEmail = event.attendees?.find(a => !a.organizer && a.email !== event.organizer?.email)?.email;
                        
                        processedClients[name] = {
                            eventId: event.id, discipline, sessionNumber, studentEmail,
                            startTime: event.start?.dateTime,
                            phone: phone || processedClients[name]?.phone,
                            lastPayment: lastPayment || processedClients[name]?.lastPayment,
                        };
                    });
                return processedClients;
            };

            const api = {
                async getEvents(day) {
                    const params = new URLSearchParams({ singleEvents: 'true', orderBy: 'startTime', maxResults: '2500' });
                    if (day === 'all') {
                        params.append('q', '" - Sedinta "');
                    } else {
                        const targetDate = new Date();
                        if (day === 'tomorrow') targetDate.setDate(targetDate.getDate() + 1);
                        const startOfDay = new Date(targetDate);
                        startOfDay.setHours(0, 0, 0, 0);
                        params.append('timeMin', startOfDay.toISOString());
                        const endOfDay = new Date(targetDate);
                        endOfDay.setHours(23, 59, 59, 999);
                        params.append('timeMax', endOfDay.toISOString());
                    }
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(state.calendarId)}/events?${params.toString()}`;
                    const response = await fetch(url, { headers: { 'Authorization': `Bearer ${state.accessToken}` } });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return processCalendarItems(data.items);
                },
                async searchEvents(query) {
                    const params = new URLSearchParams({ q: `${query} " - Sedinta "`, singleEvents: 'true', orderBy: 'startTime', maxResults: '2500' });
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(state.calendarId)}/events?${params.toString()}`;
                    const response = await fetch(url, { headers: { 'Authorization': `Bearer ${state.accessToken}` } });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return processCalendarItems(data.items);
                },
                // FIXED: Rewritten to look for organizer's "declined" status.
                async fetchHistory(clientName) {
                    const sixtyDaysAgo = new Date();
                    sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(state.calendarId)}/events?timeMin=${sixtyDaysAgo.toISOString()}&timeMax=${new Date().toISOString()}&q=${encodeURIComponent(`${clientName} - `)}&singleEvents=true&orderBy=startTime&showDeleted=true`;
                    const response = await fetch(url, { headers: { 'Authorization': `Bearer ${state.accessToken}` } });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    const allEvents = (data.items || [])
                        .map(event => {
                            const organizer = event.attendees?.find(a => a.organizer);
                            const isDeclinedByOrganizer = organizer?.responseStatus === 'declined';
                            
                            return {
                                id: event.id,
                                date: event.start?.dateTime || event.start?.date,
                                summary: event.summary,
                                isDeclinedByOrganizer: isDeclinedByOrganizer,
                                status: event.status // Keep original status for reference
                            };
                        })
                        .filter(event => event.summary && event.date);

                    const confirmedEvents = allEvents.filter(e => !e.isDeclinedByOrganizer && e.status === 'confirmed');
                    const cancelledEvents = allEvents.filter(e => e.isDeclinedByOrganizer);

                    const processedCancelledEvents = cancelledEvents.map(cancelledEvent => {
                        const correspondingConfirmed = confirmedEvents.find(confirmedEvent => 
                            confirmedEvent.summary === cancelledEvent.summary && 
                            new Date(confirmedEvent.date) > new Date(cancelledEvent.date)
                        );

                        if (correspondingConfirmed) {
                            return { ...cancelledEvent, status: 'rescheduled', rescheduledTo: correspondingConfirmed.date };
                        } else {
                            return { ...cancelledEvent, status: 'cancelled' };
                        }
                    });

                    const finalHistory = [...confirmedEvents, ...processedCancelledEvents];
                    
                    const history = finalHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    return history.reduce((acc, session) => {
                        const monthYear = new Date(session.date).toLocaleString('ro-RO', { month: 'long', year: 'numeric' });
                        const capitalized = monthYear.charAt(0).toUpperCase() + monthYear.slice(1);
                        if (!acc[capitalized]) acc[capitalized] = [];
                        acc[capitalized].push(session);
                        return acc;
                    }, {});
                },
                // FIXED: Reverted to setting organizer's responseStatus to "declined".
                async declineEvent(eventId) {
                    const getUrl = `https://www.googleapis.com/calendar/v3/calendars/${state.calendarId}/events/${eventId}`;
                    const getResponse = await fetch(getUrl, { headers: { 'Authorization': `Bearer ${state.accessToken}` } });
                    const eventData = await getResponse.json();
                    if (eventData.error) throw new Error(`Failed to get event details: ${eventData.error.message}`);
                    
                    const organizerEmail = eventData.organizer?.email;
                    if (!organizerEmail) {
                        throw new Error("Could not identify the event organizer.");
                    }

                    if (!eventData.attendees) {
                         throw new Error("Event has no attendees list to modify.");
                    }

                    const updatedAttendees = eventData.attendees.map(attendee => {
                        if (attendee.email === organizerEmail) {
                            return { ...attendee, responseStatus: 'declined' };
                        }
                        return attendee;
                    });

                    const patchUrl = `https://www.googleapis.com/calendar/v3/calendars/${state.calendarId}/events/${eventId}`;
                    const patchResponse = await fetch(patchUrl, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${state.accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ attendees: updatedAttendees })
                    });
                    const patchData = await patchResponse.json();
                    if (patchData.error) throw new Error(`Failed to update event: ${patchData.error.message}`);
                    return patchData;
                },
                async fetchCourses() {
                    const response = await fetch('https://classroom.googleapis.com/v1/courses', { headers: { 'Authorization': `Bearer ${state.accessToken}` } });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return data.courses || [];
                },
                async postHomework({ courseId, studentEmail, discipline, homework }) {
                    const title = `Temă (${new Date().toLocaleDateString('ro-RO')}) - ${discipline}`;
                    const url = `https://classroom.googleapis.com/v1/courses/${courseId}/courseWork`;
                    const body = { title, description: homework, workType: 'ASSIGNMENT', state: 'PUBLISHED', assigneeMode: 'INDIVIDUAL_STUDENTS', individualStudentsOptions: { studentIds: [studentEmail] } };
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${state.accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return data;
                },
                async updateEventSummary(eventId, newSummary, colorId = null) {
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${state.calendarId}/events/${eventId}`;
                    const body = {
                        summary: newSummary,
                        colorId: colorId
                    };
                    const response = await fetch(url, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return data;
                },
            };
            
            const renderNotification = (message, type = 'success') => {
                const colors = {
                    error: { bg: 'bg-red-100', border: 'border-red-500', text: 'text-red-700', icon: 'shield-alert' },
                    success: { bg: 'bg-green-100', border: 'border-green-500', text: 'text-green-700', icon: 'info' },
                };
                const selected = colors[type];
                dom.notificationArea.innerHTML = `
                    <div class="fade-in ${selected.bg} border-l-4 ${selected.border} ${selected.text} p-4 rounded-md shadow-md relative" role="alert">
                        <div class="flex">
                            <div class="py-1"><i data-lucide="${selected.icon}" class="h-6 w-6 mr-4"></i></div>
                            <div>
                                <p class="font-bold">${type.charAt(0).toUpperCase() + type.slice(1)}</p>
                                <p class="text-sm">${message}</p>
                            </div>
                        </div>
                        <button onclick="document.getElementById('notification-area').innerHTML = ''" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">
                            <i data-lucide="x-circle" class="h-5 w-5"></i>
                        </button>
                    </div>
                `;
                lucide.createIcons();
            };

            const renderLoader = (message) => {
                dom.resultsArea.innerHTML = `<div class="flex items-center justify-center p-10"><i data-lucide="loader-2" class="h-8 w-8 animate-spin text-blue-600"></i><span class="ml-3 text-lg">${message}</span></div>`;
                lucide.createIcons();
            };
            
            const renderClients = (clientsToDisplay) => {
                state.fetched = true;
                if (!clientsToDisplay || Object.keys(clientsToDisplay).length === 0) {
                    const tabTitle = { today: 'astăzi', tomorrow: 'mâine', all: 'toți clienții' }[state.activeTab];
                    const message = state.searchQuery ? `Niciun client găsit pentru "${state.searchQuery}".` : `Nu s-au găsit programări cu formatul "Nume - Disciplina - Sedinta #" pentru ${tabTitle}.`;
                    dom.resultsArea.innerHTML = `<div class="text-center py-12"><p class="text-lg text-gray-500">${message}</p></div>`;
                    return;
                }

                const displayTitle = getDisplayTitle();
                const clientListHTML = Object.entries(clientsToDisplay)
                    .sort(([nameA], [nameB]) => nameA.localeCompare(nameB))
                    .map(([name, details]) => createClientListItemHTML(name, details))
                    .join('');

                dom.resultsArea.innerHTML = `
                    <div class="bg-white shadow-xl rounded-2xl overflow-hidden fade-in">
                        <div class="px-6 py-4 bg-gray-100 border-b border-gray-200">
                            <h2 class="text-2xl font-bold text-gray-700">${displayTitle}</h2>
                        </div>
                        <ul class="divide-y divide-gray-200">${clientListHTML}</ul>
                    </div>
                `;
                lucide.createIcons();
                attachClientEventListeners();
            };
            
            const createClientListItemHTML = (name, details) => {
                const { eventId, discipline, sessionNumber, phone, startTime, lastPayment } = details;
                const isExpanded = state.expandedClient === name;
                const formattedTime = startTime ? new Date(startTime).toLocaleTimeString('ro-RO', { hour: '2-digit', minute: '2-digit' }) : '';
                const dayText = state.activeTab === 'today' ? 'astăzi' : 'mâine';
                const notificationMessage = `Salut ${name}! Sunt Tudor de la Asorte Music Academy si te contactez pentru a te intreba daca iti confirmi prezenta pentru cursul de ${discipline} pe care il ai programat pentru ${dayText}, la ora ${formattedTime}. Iti multumim si te așteptăm cu drag!`;
                const lastSessionMessage = `Salut ${name}! Îți reamintim cu drag că sesiunea ${dayText === 'astăzi' ? 'de astăzi' : 'de mâine'} este ultima din abonamentul tău. Poți face plata accesand acest link: https://www.asortemediaproductions.com/paginapreturi. O zi frumoasă!`;
                const newSubMessage = `Salut ${name}! Îți reamintim cu drag că următoarea ședință este prima dintr-un nou abonament și necesită o nouă plată. Poți face plata accesand acest link: https://www.asortemediaproductions.com/paginapreturi. O zi frumoasă!`;

                return `
                    <li id="client-${eventId}" class="px-6 py-5 hover:bg-gray-50 transition-colors duration-200">
                        <div class="flex items-center justify-between flex-wrap cursor-pointer client-header" data-name="${name}">
                            <!-- Client Info -->
                            <div class="flex-grow mb-4 md:mb-0">
                                <div class="flex items-center">
                                    <span class="text-2xl font-semibold text-gray-900 bg-gray-100 px-3 py-1 rounded-lg">${name}</span>
                                    <i data-lucide="chevron-down" class="h-5 w-5 ml-2 text-gray-500 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}"></i>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">${discipline}</p>
                                ${(state.activeTab === 'today' || state.activeTab === 'tomorrow') && startTime ? `<div class="flex items-center mt-1 text-sm text-blue-600 font-semibold"><i data-lucide="clock" class="h-4 w-4 mr-2"></i><span>${formattedTime}</span></div>` : ''}
                                ${phone ? `<button class="whatsapp-btn flex items-center justify-center mt-2 bg-green-500 text-white font-bold py-1.5 px-3 rounded-lg hover:bg-green-600 text-xs w-fit" data-phone="${phone}"><svg role="img" viewBox="0 0 24 24" class="h-4 w-4 mr-2" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52s-.67-.816-.916-1.103c-.247-.287-.5-.318-.67-.323-.172-.005-.371-.005-.57-.005-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871-.118.571-.355 1.758-2.16 2.03-2.874.272-.714.272-1.319.198-1.469-.074-.15-.272-.222-.57-.371z"/></svg><span>${phone}</span></button>` : ''}
                                ${lastPayment ? `<div class="flex items-center mt-1 text-sm ${isPaymentOverdue(lastPayment) ? 'text-red-600 font-semibold' : 'text-gray-600'}"><i data-lucide="dollar-sign" class="h-4 w-4 mr-2"></i><span>Last Payment: ${lastPayment.startsWith('20') ? new Date(lastPayment.split(' - ')[0]).toLocaleDateString('ro-RO', { day: 'numeric', month: 'long', year: 'numeric' }) : lastPayment}</span></div>` : ''}
                            </div>
                            <!-- Action Buttons -->
                            <div class="flex flex-col items-end space-y-2 w-48">
                                <div class="w-full text-right mb-2">
                                    <span class="text-xs font-medium text-gray-600">Sedinta ${sessionNumber} / 4</span>
                                    <div class="mt-1 w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${Math.min((sessionNumber / 4) * 100, 100)}%"></div></div>
                                </div>
                                <button class="whatsapp-btn w-full flex items-center justify-center bg-green-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-600 disabled:bg-gray-400 text-xs" data-phone="${phone}" data-message="${notificationMessage}" ${!phone || !startTime || state.activeTab === 'all' ? 'disabled' : ''}><i data-lucide="message-square" class="h-4 w-4 mr-1.5"></i><span>Notificare sedinta</span></button>
                                <button class="whatsapp-btn w-full flex items-center justify-center bg-orange-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-orange-600 disabled:bg-gray-400 text-xs" data-phone="${phone}" data-message="${lastSessionMessage}" ${sessionNumber !== 4 || !phone || state.activeTab === 'all' ? 'disabled' : ''}><i data-lucide="credit-card" class="h-4 w-4 mr-1.5"></i><span>Notificare ultima sedinta</span></button>
                                <button class="whatsapp-btn w-full flex items-center justify-center bg-teal-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-teal-600 disabled:bg-gray-400 text-xs" data-phone="${phone}" data-message="${newSubMessage}" ${sessionNumber !== 1 || !phone || state.activeTab === 'all' ? 'disabled' : ''}><i data-lucide="refresh-cw" class="h-4 w-4 mr-1.5"></i><span>Notificare plată nouă</span></button>
                                <button class="decline-btn w-full flex items-center justify-center bg-red-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-600 disabled:bg-gray-400 text-xs" data-event-id="${eventId}" data-name="${name}" data-discipline="${discipline}" data-phone="${phone}" ${state.activeTab !== 'today' && state.activeTab !== 'tomorrow' ? 'disabled' : ''}><i data-lucide="x-circle" class="h-4 w-4 mr-1.5"></i><span>Anulează</span></button>
                                <button class="increment-session-btn w-full flex items-center justify-center bg-blue-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-600 disabled:bg-gray-400 text-xs" data-event-id="${eventId}" data-name="${name}" ${state.activeTab !== 'today' && state.activeTab !== 'tomorrow' ? 'disabled' : ''}>
                                    <i data-lucide="plus-circle" class="h-4 w-4 mr-1.5"></i><span>Incrementeaza sedinta</span>
                                </button>
                            </div>
                        </div>
                        <div class="client-details w-full" style="display: ${isExpanded ? 'block' : 'none'};">
                            <!-- Details will be loaded here -->
                        </div>
                    </li>
                `;
            };
            
            const createHomeworkHTML = (name, client) => {
                if (!client) return '';
                if (!state.courses) return `<p>Se încarcă cursurile...</p>`;
                if (state.courses.length === 0) return `<p class="text-red-500">No Google Classroom courses found.</p>`;
                
                const courseOptions = state.courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                return `
                    <div class="mb-4 homework-form" data-name="${name}">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Temă pentru Acasă</h4>
                        <div class="flex items-center space-x-2 mb-2">
                            <label class="text-sm font-medium">Curs:</label>
                            <select class="course-select block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">${courseOptions}</select>
                        </div>
                        <textarea rows="4" class="homework-text w-full p-2 border border-gray-300 rounded-md" placeholder="Scrie tema aici..."></textarea>
                        <button class="post-homework-btn mt-2 flex items-center justify-center bg-blue-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-600 disabled:bg-gray-400 text-xs" data-discipline="${client.discipline}" data-student-email="${client.studentEmail || ''}" ${!client.studentEmail ? 'disabled' : ''}>
                            <i data-lucide="book" class="h-4 w-4 mr-1.5"></i><span>Postează Tema</span>
                        </button>
                        ${!client.studentEmail ? `<p class="text-xs text-red-500 mt-1">Nu s-a găsit e-mailul studentului.</p>` : ''}
                    </div>
                `;
            };

            const createHistoryHTML = (history) => {
                if (Object.keys(history).length === 0) return `<p class="text-sm text-gray-500">Nu s-au găsit ședințe în ultimele 60 de zile.</p>`;
                return `<ul class="space-y-2">` + Object.entries(history).map(([monthYear, sessions]) => `
                    <li>
                        <div class="history-month-header flex items-center justify-between p-2 bg-gray-100 rounded-md cursor-pointer">
                            <span class="font-semibold text-gray-800">${monthYear}</span>
                            <i data-lucide="chevron-down" class="h-5 w-5 text-gray-600 transition-transform duration-300"></i>
                        </div>
                        <ul class="history-month-list mt-2 pl-4 space-y-1" style="display: none;">
                            ${sessions.map(s => {
                                const date = new Date(s.date);
                                if (isNaN(date.getTime())) return ''; 

                                const statusClass = s.status === 'cancelled' ? 'bg-red-100 text-red-800' : s.status === 'rescheduled' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-50 text-gray-600';
                                
                                const rescheduledDate = s.rescheduledTo ? new Date(s.rescheduledTo) : null;
                                const rescheduledText = rescheduledDate && !isNaN(rescheduledDate.getTime()) 
                                    ? `(Reprogramat pentru ${rescheduledDate.toLocaleDateString('ro-RO', { day: 'numeric', month: 'long' })})`
                                    : '';

                                const statusText = s.status === 'cancelled' ? '(Anulat)' : s.status === 'rescheduled' ? rescheduledText : '';
                                
                                return `<li class="text-sm p-2 rounded-md ${statusClass}">${date.toLocaleDateString('ro-RO', { weekday: 'long', day: 'numeric' })} - ${s.summary} <span class="font-semibold ml-2">${statusText}</span></li>`;
                            }).join('')}
                        </ul>
                    </li>
                `).join('') + `</ul>`;
            };
            
            const getDisplayTitle = () => {
                if (state.searchQuery) return 'Rezultate Căutare';
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                if (state.activeTab === 'today') return `Sumar Clienți pentru Astăzi (${new Date().toLocaleDateString('ro-RO', options)})`;
                if (state.activeTab === 'tomorrow') {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return `Sumar Clienți pentru Mâine (${tomorrow.toLocaleDateString('ro-RO', options)})`;
                }
                return 'Sumar Toți Clienții';
            };

            const handleFetchEvents = async () => {
                if (!state.accessToken || !state.calendarId) {
                    renderNotification('Authentication is required and Calendar ID must be set.', 'error');
                    return;
                }
                state.isLoading = true;
                state.searchQuery = '';
                dom.searchQueryInput.value = '';
                renderLoader('Se încarcă...');
                updateUI();

                try {
                    state.clients = await api.getEvents(state.activeTab);
                    renderClients(state.clients);
                } catch (err) {
                    renderNotification(`Failed to fetch events: ${err.message}`, 'error');
                    dom.resultsArea.innerHTML = '';
                } finally {
                    state.isLoading = false;
                    updateUI();
                }
            };

            const handleSearch = async () => {
                if (state.searchQuery.trim().length < 3) {
                    state.clients = {}; 
                    renderClients({});
                    return;
                }
                state.isSearching = true;
                renderLoader('Se caută...');
                updateUI();

                try {
                    state.clients = await api.searchEvents(state.searchQuery);
                    renderClients(state.clients);
                } catch (err) {
                    renderNotification(`Search failed: ${err.message}`, 'error');
                    dom.resultsArea.innerHTML = '';
                } finally {
                    state.isSearching = false;
                    updateUI();
                }
            };
            
            const handleDeclineClick = async (button) => {
                const { eventId, name, discipline, phone } = button.dataset;
                button.innerHTML = `<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i>`;
                button.disabled = true;
                lucide.createIcons();

                try {
                    await api.declineEvent(eventId);
                    renderNotification(`Event for ${name} has been declined.`, 'success');
                    document.getElementById(`client-${eventId}`).remove();
                    const message = `Sedinta ta de ${discipline} care era programata la Asorte a fost anulata. Mentionam ca datorita faptului ca anularea a avut loc cu mai putin de 48 de ore inaintea datei si orei convenite initial, sesiunea va fi considerata ca fiind efectuata`;
                    const link = getWhatsAppLink(phone, message);
                    if (link) window.open(link, '_blank');
                } catch (err) {
                    renderNotification(`Failed to decline event: ${err.message}`, 'error');
                    button.innerHTML = `<i data-lucide="x-circle" class="h-4 w-4 mr-1.5"></i><span>Anulează</span>`;
                    lucide.createIcons();
                } finally {
                    button.disabled = false;
                }
            };
            
            const handlePostHomeworkClick = async (button) => {
                const form = button.closest('.homework-form');
                const { name } = form.dataset;
                const { studentEmail, discipline } = button.dataset;
                const courseId = form.querySelector('.course-select').value;
                const homework = form.querySelector('.homework-text').value;

                if (!homework || !studentEmail || !courseId) {
                    renderNotification("Please select a course, ensure student has an email, and write homework.", "error");
                    return;
                }
                
                button.innerHTML = `<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i><span>Se postează...</span>`;
                button.disabled = true;
                lucide.createIcons();

                try {
                    await api.postHomework({ courseId, studentEmail, discipline, homework });
                    renderNotification(`Homework posted for ${name}`, 'success');
                    form.querySelector('.homework-text').value = '';
                } catch (err) {
                    renderNotification(`Failed to post homework: ${err.message}`, 'error');
                } finally {
                    button.innerHTML = `<i data-lucide="book" class="h-4 w-4 mr-1.5"></i><span>Postează Tema</span>`;
                    button.disabled = false;
                    lucide.createIcons();
                }
            };

            const handleIncrementSessionClick = async (button) => {
                const { eventId, name } = button.dataset;
                const clientDetails = state.clients[name];

                if (!clientDetails || (state.activeTab !== 'today' && state.activeTab !== 'tomorrow')) {
                    renderNotification('Session increment is only available for today\'s or tomorrow\'s sessions.', 'error');
                    return;
                }

                let currentSessionNumber = clientDetails.sessionNumber;
                let newSessionNumber = (currentSessionNumber % 4) + 1; 
                
                let colorToApply = null; 
                if (newSessionNumber === 1) {
                    colorToApply = '10'; // Green (Basil)
                } else if (newSessionNumber === 2 || newSessionNumber === 3) {
                    colorToApply = '8'; // Gray (Graphite)
                } else if (newSessionNumber === 4) {
                    colorToApply = '11'; // Red (Tomato)
                }

                const newSummary = `${name} - ${clientDetails.discipline} - Sedinta ${newSessionNumber}`;

                button.innerHTML = `<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i>`;
                button.disabled = true;
                lucide.createIcons();

                try {
                    await api.updateEventSummary(eventId, newSummary, colorToApply);
                    renderNotification(`Session for ${name} incremented to ${newSessionNumber}. Event color updated.`, 'success');

                    state.clients[name].sessionNumber = newSessionNumber;
                    renderClients(state.clients); 
                } catch (err) {
                    renderNotification(`Failed to increment session for ${name}: ${err.message}`, 'error');
                } finally {
                    button.innerHTML = `<i data-lucide="plus-circle" class="h-4 w-4 mr-1.5"></i><span>Increment Session</span>`;
                    button.disabled = false;
                    lucide.createIcons();
                }
            };
            
            function attachAppEventListeners() {
                dom.calendarIdInput.addEventListener('change', (e) => state.calendarId = e.target.value);
                dom.fetchEventsBtn.addEventListener('click', handleFetchEvents);

                let searchTimeout;
                dom.searchQueryInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    state.searchQuery = e.target.value;
                    if (state.searchQuery.trim()) {
                        dom.tabControls.style.display = 'none';
                        searchTimeout = setTimeout(handleSearch, 500);
                    } else {
                        dom.tabControls.style.display = 'block';
                        dom.resultsArea.innerHTML = '';
                    }
                });

                dom.tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        state.activeTab = button.dataset.tab;
                        updateUI();
                        handleFetchEvents();
                    });
                });
            }

            const attachClientEventListeners = () => {
                document.querySelectorAll('.client-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const name = header.dataset.name;
                        const detailsContainer = header.parentElement.querySelector('.client-details');
                        const isOpening = state.expandedClient !== name;
                        
                        if (state.expandedClient && state.expandedClient !== name) {
                            const oldHeader = Array.from(document.querySelectorAll('.client-header')).find(h => h.dataset.name === state.expandedClient);
                            if (oldHeader) {
                                oldHeader.parentElement.querySelector('.client-details').style.display = 'none';
                                oldHeader.querySelector('[data-lucide="chevron-down"]').classList.remove('rotate-180');
                            }
                        }
                        
                        state.expandedClient = isOpening ? name : null;
                        detailsContainer.style.display = isOpening ? 'block' : 'none';
                        header.querySelector('[data-lucide="chevron-down"]').classList.toggle('rotate-180', isOpening);
                        
                        if (isOpening) {
                            renderClientDetails(name, detailsContainer);
                        }
                    });
                });

                document.querySelectorAll('.whatsapp-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const { phone, message } = e.currentTarget.dataset;
                        const link = getWhatsAppLink(phone, message);
                        if (link) window.open(link, '_blank');
                        else renderNotification('No phone number available for this client.', 'error');
                    });
                });
                
                document.querySelectorAll('.decline-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleDeclineClick(e.currentTarget);
                    });
                });

                document.querySelectorAll('.increment-session-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleIncrementSessionClick(e.currentTarget);
                    });
                });
            };
            
            const renderClientDetails = async (name, container) => {
                container.innerHTML = `<div class="p-4 border-t border-gray-200 flex justify-center"><i data-lucide="loader-2" class="h-6 w-6 animate-spin text-gray-500"></i></div>`;
                lucide.createIcons();
                try {
                    const client = state.clients[name];
                    const history = await api.fetchHistory(name);
                    const homeworkHTML = createHomeworkHTML(name, client);
                    const historyHTML = createHistoryHTML(history);
                    container.innerHTML = `
                        <div class="p-6 border-t border-gray-200 space-y-6">
                            <div>
                                <h4 class="text-md font-semibold text-gray-700 mb-2">Istoric Ședințe (Ultimele 60 de zile)</h4>
                                ${historyHTML}
                            </div>
                            <div>
                                ${homeworkHTML}
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                    attachDetailEventListeners(name, container);
                } catch (err) {
                    container.innerHTML = `<div class="p-4 border-t border-gray-200 text-red-500">Failed to load details: ${err.message}</div>`;
                }
            };
            
            const attachDetailEventListeners = (name, container) => {
                container.querySelector('.post-homework-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handlePostHomeworkClick(e.currentTarget);
                });
                container.querySelectorAll('.history-month-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const list = header.nextElementSibling;
                        const icon = header.querySelector('i');
                        const isVisible = list.style.display !== 'none';
                        list.style.display = isVisible ? 'none' : 'block';
                        icon.classList.toggle('rotate-180', !isVisible);
                    });
                });
            };

            const updateUI = () => {
                dom.tabButtons.forEach(btn => {
                    const isSelected = btn.dataset.tab === state.activeTab;
                    btn.className = `tab-button flex-1 text-center px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 ${isSelected ? 'border-b-2 border-blue-600 text-blue-600 bg-blue-50' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'}`;
                });
                
                const tabTitle = { today: 'astăzi', tomorrow: 'mâine', all: 'toți clienții' }[state.activeTab];
                dom.fetchEventsBtn.textContent = `Afișează programările pentru ${tabTitle}`;
                dom.fetchEventsBtn.disabled = state.isLoading;
            };

            window.onload = () => {
                initializeGsi();
                lucide.createIcons();
            };
        });
    </script>
</body>
</html>
